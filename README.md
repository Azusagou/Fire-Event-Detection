# 火灾事件音频检测系统 (增强版)

这是一个基于深度学习的火灾事件音频检测系统，通过时序分析和变点检测技术提高检测准确性。系统结合了CNN14深度学习模型和贝叶斯在线变点检测(BOCD)，能够分析音频数据中的时序特征，准确识别火灾事件的开始和结束。

## 系统特点

- **贝叶斯在线变点检测(BOCD)**：实时检测概率序列中的变点，准确识别火灾事件的开始和结束
- **序列处理能力**：将音频分割成固定长度片段，支持任意长度的音频分析
- **可视化工具**：提供检测结果的静态图和详细文本报告，方便分析
- **多种接口**：支持Web界面和命令行两种使用方式
- 支持上传各种格式的音频文件（WAV、MP3等）
- 提供友好的Web界面，方便演示和使用
- 使用ONNX优化，提供快速的推理速度

## 项目结构

```
├── wav/                       # 原始音频文件目录
├── experiments/               # 实验结果和模型文件目录
├── dataset.py                 # 数据集处理代码
├── models.py                  # 模型定义代码
├── baseline.py                # 基础模型训练和评估代码
├── baseline_app.py            # 基础Web应用
├── bocd_detector.py           # 贝叶斯在线变点检测实现
├── fire_event_detection_app.py # 增强版Web应用（含BOCD检测）
├── test_fire_detection.py     # 命令行测试脚本
├── prepare_data.py            # 数据预处理代码
├── convert_model.py           # 模型格式转换工具
└── requirements.txt           # 项目依赖文件
```

## 贝叶斯在线变点检测(BOCD)

BOCD是一种实时检测时间序列中变化点的技术，特别适合火灾检测场景：

1. **增强的概率估计**：综合考虑历史概率和当前概率
2. **趋势分析**：捕捉火灾概率的上升和下降趋势
3. **变点检测**：准确识别火灾开始和结束的时间点
4. **鲁棒性**：减少噪声和短暂波动的影响

BOCD的工作流程：
1. CNN模型对每个5秒的音频片段预测火灾概率
2. 使用滑动窗口平滑概率序列，减少噪声影响
3. BOCD算法检测概率序列中的变点
4. 根据变点和概率水平识别火灾事件区间
5. 生成可视化结果和详细报告

## 环境要求

- Python 3.7+
- PyTorch 1.7+
- CUDA (可选，用于GPU加速)

### 依赖包

```
torch>=1.7.0
numpy>=1.19.0
librosa>=0.8.0
gradio>=3.0.0
matplotlib>=3.3.0
seaborn>=0.11.0
scikit-learn>=0.24.0
tqdm>=4.50.0
h5py>=3.1.0
pandas>=1.1.0
torchlibrosa>=0.0.9
onnxruntime>=1.7.0
scipy>=1.5.0
```

## 安装步骤

1. 克隆或下载本仓库

2. 创建并激活虚拟环境（推荐）
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\\Scripts\\activate   # Windows
```

3. 安装依赖
```bash
pip install -r requirements.txt
```

4. 准备数据集
- 将原始音频文件(.WAV)放入`wav`目录
- 确保`spruce_oak_pmma_pur_chipboard.csv`文件存在
- 运行数据预处理：
```bash
python prepare_data.py
```

## 模型训练

### 训练基础模型
```bash
python baseline.py train_model cpu  # 使用CPU训练
# 或
python baseline.py train_model cuda  # 使用GPU训练
```

## 火灾事件检测

### 使用Web界面

启动增强版的Web应用：

```bash
python fire_event_detection_app.py
```

Web界面提供以下功能：
- 上传音频文件进行分析
- 可视化显示检测结果
- 保存检测结果到文件

### 使用命令行脚本

通过命令行脚本对特定音频文件进行检测：

```bash
python test_fire_detection.py
```

可以修改脚本中的`test_file`变量来指定要分析的音频文件。

## 检测结果说明

系统检测的结果包括：

1. **变点信息**：检测到的概率序列中的变点位置
2. **火灾事件区间**：识别出的火灾开始和结束时间
3. **概率变化图**：显示原始概率和平滑后的概率变化
4. **统计信息**：平均概率等汇总数据

## 参数调优

BOCD检测器的主要参数：

1. **threshold**（变点检测阈值）：
   - 默认值：0.3
   - 降低阈值会增加变点的敏感度，但可能增加误报
   - 增加阈值会减少误报，但可能导致漏报

2. **smoothing_window**（平滑窗口大小）：
   - 默认值：5
   - 增大窗口会使概率曲线更平滑，减少噪声影响
   - 减小窗口会保留更多细节变化

## 模型说明

### 基础模型(CNN14)
- 基于PANNs (Pretrained Audio Neural Networks)的CNN14结构
- 使用梅尔频谱图作为特征
- 输出：火灾事件概率（0-1之间）

## 性能优化建议

1. 模型优化
   - 优化BOCD参数（变点检测阈值和平滑窗口大小）
   - 考虑使用模型量化减小体积

2. 硬件优化
   - 使用GPU加速（推荐）
   - 配置足够的内存（建议8GB以上）

3. 使用优化
   - 对于长音频，调整平滑窗口大小可能会影响变点检测的准确性
   - 如果检测结果不理想，尝试调整BOCD阈值参数

## 常见问题

1. 音频加载失败
   - 检查音频文件格式是否支持
   - 确保librosa库正确安装

2. 模型加载失败
   - 确保ONNX模型文件存在
   - 检查onnxruntime库是否正确安装

3. 检测结果不准确
   - 调整BOCD的阈值参数
   - 调整平滑窗口大小
   - 检查音频质量，可能存在噪声干扰

## 开发计划

- [ ] 添加Transformer变体模型
- [ ] 实现模型蒸馏
- [ ] 添加多模态支持
- [ ] 开发实时监控系统
- [ ] 实现移动设备部署 